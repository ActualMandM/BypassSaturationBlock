#include "Config.h"

// v1.00: 0x140CC3E30
// v1.01: 0x140CBDF50
char* copyrightString;

// v1.00: 0x140279F80
// v1.01: 0x14027A450
SIG_SCAN
(
	sigPVMark,
	"\x40\x53\x48\x83\xEC\x60\x48\x8D\x99\x00\x00\x00\x00\x48\x8B\xCB\xE8\x00\x00\x00\x00\xF3\x0F\x10\x05\x00\x00\x00\x00\x4C\x8D\x0D\x00\x00\x00\x00\x33\xC0\x41\xB8\x00\x00\x00\x00\x48\x89\x44\x24\x00\xF3\x0F\x11\x44\x24\x00\xF3\x0F\x11\x44\x24\x00\x48\x89\x44\x24\x00\x8D\x50\x0A\x48\x89\x44\x24\x00\x8D\x48\x03\x89\x44\x24\x28\x48\x89\x44\x24\x00\xE8\x00\x00\x00\x00\x89\x03\x48\x83\xC4\x60\x5B\xC3",
	"xxxxxxxxx????xxxx????xxxx????xxx????xxxx????xxxx?xxxxx?xxxxx?xxxx?xxxxxxx?xxxxxxxxxxx?x????xxxxxxxx"
);

// v1.00: 0x140608360
// v1.01: 0x140602FB0
SIG_SCAN
(
	sigScreenshot,
	"\x48\x89\x5C\x24\x00\x48\x89\x4C\x24\x00\x57\x48\x83\xEC\x20\x48\x8B\xD9\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x01\x33\xFF\x89\x79\x08\x48\x89\x79\x10\x48\x89\x79\x18\x48\x83\xC1\x20\xE8\x00\x00\x00\x00\x90\xC7\x43\x00\x00\x00\x00\x00\xC7\x43\x00\x00\x00\x00\x00\x48\xC7\x43\x00\x00\x00\x00\x00\x48\x8D\x4B\x40\x40\x88\x79\x08\x89\x79\x0C\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x01\xBA\x00\x00\x00\x00\xFF\x15\x00\x00\x00\x00\x90\x48\x8D\x4B\x50\x40\x88\x79\x08\x89\x79\x0C\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x01\xBA\x00\x00\x00\x00\xFF\x15\x00\x00\x00\x00\x90\x48\x8D\x0D\x00\x00\x00\x00\xFF\x15\x00\x00\x00\x00\x48\x8B\x08\x48\x8B\x01\xB2\x01\xFF\x50\x18\x90\x48\x8B\xC3\x48\x8B\x5C\x24\x00\x48\x83\xC4\x20\x5F\xC3",
	"xxxx?xxxx?xxxxxxxxxxx????xxxxxxxxxxxxxxxxxxxxx????xxx?????xx?????xxx?????xxxxxxxxxxxxxx????xxxx????xx????xxxxxxxxxxxxxxx????xxxx????xx????xxxx????xx????xxxxxxxxxxxxxxxxxxx?xxxxxx"
);

// v1.00: 0x140608680
// v1.01: 0x1406032D0
SIG_SCAN
(
	sigCopyright,
	"\x48\x89\x5C\x24\x00\x48\x89\x6C\x24\x00\x48\x89\x74\x24\x00\x57\x48\x83\xEC\x30\x48\x8B\xE9\xBB\x00\x00\x00\x00\x65\x48\x8B\x04\x25\x00\x00\x00\x00\x48\x03\x18\x48\x8D\x35\x00\x00\x00\x00\x8B\x03\x39\x05\x00\x00\x00\x00\x0F\x8F\x00\x00\x00\x00\x48\x8D\x3D\x00\x00\x00\x00\x8B\x03\x39\x05\x00\x00\x00\x00\x7F\x56\x48\x83\x3D\x00\x00\x00\x00\x00\x48\x0F\x43\x3D\x00\x00\x00\x00\x48\x83\x3D\x00\x00\x00\x00\x00\x48\x0F\x43\x35\x00\x00\x00\x00\x48\x8D\x4D\x20\xC6\x44\x24\x00\x00\x45\x33\xC9\x4C\x8B\xC7\x48\x8B\xD6\xE8\x00\x00\x00\x00\xF6\xD8\x1B\xC9\x83\xC1\x02\x89\x4D\x08\x48\x8B\x5C\x24\x00\x48\x8B\x6C\x24\x00\x48\x8B\x74\x24\x00\x48\x83\xC4\x30\x5F\xC3\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x83\x3D\x00\x00\x00\x00\x00\x75\x95\x41\xB8\x00\x00\x00\x00\x48\x8D\x15\x00\x00\x00\x00\x48\x8B\xCF\xE8\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x90\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE9\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x83\x3D\x00\x00\x00\x00\x00\x0F\x85\x00\x00\x00\x00\x41\xB8\x00\x00\x00\x00\x48\x8D\x15\x00\x00\x00\x00\x48\x8B\xCE\xE8\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x90\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE9\x00\x00\x00\x00",
	"xxxx?xxxx?xxxx?xxxxxxxxx????xxxxx????xxxxxx????xxxx????xx????xxx????xxxx????xxxxx?????xxxx????xxx?????xxxx????xxxxxxx??xxxxxxxxxx????xxxxxxxxxxxxxx?xxxx?xxxx?xxxxxxxxx????x????xx?????xxxx????xxx????xxxx????xxx????x????xxxx????x????x????xxx????x????xx?????xx????xx????xxx????xxxx????xxx????x????xxxx????x????x????"
);

extern "C" __declspec(dllexport) void Init()
{
	Config::init();

	if (Config::pvMark)
		WRITE_MEMORY(sigPVMark(), uint8_t, 0xC3);

	if (Config::copyrightMark == 1) // Block game from overriding Steam screenshot
	{
		WRITE_MEMORY(sigScreenshot(), uint8_t, 0xC3);
	}
	else if (Config::copyrightMark == 2) // Redirect to disablewm.farc
	{
		uint8_t* instrAddr = (uint8_t*)sigCopyright() + 0x10B;
		copyrightString = (char*)(instrAddr + readUnalignedU32(instrAddr + 0x3) + 0x7);
		printf("[Disable Watermarks] copyrightString: 0x%08x\n", copyrightString);
		WRITE_MEMORY(copyrightString, const char, "rom/disablewm.farc");
	}
}
