#include "Config.h"

// v1.00: 0x140CC3E30
// v1.01: 0x140CBDF50
char* copyrightString;

// v1.00: 0x1416E9A69
// v1.01: 0x1416E3A59
bool* pvMode;

// v1.00: 0x140279F80
// v1.01: 0x14027A450
SIG_SCAN
(
	sigPVMark,
	"\x40\x53\x48\x83\xEC\x60\x48\x8D\x99\x00\x00\x00\x00\x48\x8B\xCB\xE8\x00\x00\x00\x00\xF3\x0F\x10\x05\x00\x00\x00\x00\x4C\x8D\x0D\x00\x00\x00\x00\x33\xC0\x41\xB8\x00\x00\x00\x00\x48\x89\x44\x24\x00\xF3\x0F\x11\x44\x24\x00\xF3\x0F\x11\x44\x24\x00\x48\x89\x44\x24\x00\x8D\x50\x0A\x48\x89\x44\x24\x00\x8D\x48\x03\x89\x44\x24\x28\x48\x89\x44\x24\x00\xE8\x00\x00\x00\x00\x89\x03\x48\x83\xC4\x60\x5B\xC3",
	"xxxxxxxxx????xxxx????xxxx????xxx????xxxx????xxxx?xxxxx?xxxxx?xxxx?xxxxxxx?xxxxxxxxxxx?x????xxxxxxxx"
);

// v1.00: 0x140608680
// v1.01: 0x1406032D0
SIG_SCAN
(
	sigCopyright,
	"\x48\x89\x5C\x24\x00\x48\x89\x6C\x24\x00\x48\x89\x74\x24\x00\x57\x48\x83\xEC\x30\x48\x8B\xE9\xBB\x00\x00\x00\x00\x65\x48\x8B\x04\x25\x00\x00\x00\x00\x48\x03\x18\x48\x8D\x35\x00\x00\x00\x00\x8B\x03\x39\x05\x00\x00\x00\x00\x0F\x8F\x00\x00\x00\x00\x48\x8D\x3D\x00\x00\x00\x00\x8B\x03\x39\x05\x00\x00\x00\x00\x7F\x56\x48\x83\x3D\x00\x00\x00\x00\x00\x48\x0F\x43\x3D\x00\x00\x00\x00\x48\x83\x3D\x00\x00\x00\x00\x00\x48\x0F\x43\x35\x00\x00\x00\x00\x48\x8D\x4D\x20\xC6\x44\x24\x00\x00\x45\x33\xC9\x4C\x8B\xC7\x48\x8B\xD6\xE8\x00\x00\x00\x00\xF6\xD8\x1B\xC9\x83\xC1\x02\x89\x4D\x08\x48\x8B\x5C\x24\x00\x48\x8B\x6C\x24\x00\x48\x8B\x74\x24\x00\x48\x83\xC4\x30\x5F\xC3\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x83\x3D\x00\x00\x00\x00\x00\x75\x95\x41\xB8\x00\x00\x00\x00\x48\x8D\x15\x00\x00\x00\x00\x48\x8B\xCF\xE8\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x90\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE9\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x83\x3D\x00\x00\x00\x00\x00\x0F\x85\x00\x00\x00\x00\x41\xB8\x00\x00\x00\x00\x48\x8D\x15\x00\x00\x00\x00\x48\x8B\xCE\xE8\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x90\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE9\x00\x00\x00\x00",
	"xxxx?xxxx?xxxx?xxxxxxxxx????xxxxx????xxxxxx????xxxx????xx????xxx????xxxx????xxxxx?????xxxx????xxx?????xxxx????xxxxxxx??xxxxxxxxxx????xxxxxxxxxxxxxx?xxxx?xxxx?xxxxxxxxx????x????xx?????xxxx????xxx????xxxx????xxx????x????xxxx????x????x????xxx????x????xx?????xx????xx????xxx????xxxx????xxx????x????xxxx????x????x????"
);

// v1.00: 0x140244D00
// v1.01: 0x1402454C0
SIG_SCAN
(
	sigLyrics,
	"\x40\x53\x48\x83\xEC\x20\x48\x8B\xD9\xE8\x00\x00\x00\x00\x80\xBB\x00\x00\x00\x00\x00\x75\x5F\xE8\x00\x00\x00\x00\x48\x8B\xC8\xE8\x00\x00\x00\x00\x83\xF8\x04\x74\x4D\x80\xBB\x00\x00\x00\x00\x00\x74\x44\x80\xBB\x00\x00\x00\x00\x00\x74\x3B\xE8\x00\x00\x00\x00\x83\xF8\x03\x74\x0F\xE8\x00\x00\x00\x00\x83\xF8\x06\x74\x05\x45\x33\xC0\xEB\x03\x41\xB0\x01\x44\x8B\x8B\x00\x00\x00\x00\x48\x8D\x93\x00\x00\x00\x00\x48\x8D\x8B\x00\x00\x00\x00\x48\x83\xC4\x20\x5B\xE9\x00\x00\x00\x00\x48\x83\xC4\x20\x5B\xC3",
	"xxxxxxxxxx????xx?????xxx????xxxx????xxxxxxx?????xxxx?????xxx????xxxxxx????xxxxxxxxxxxxxxxx????xxx????xxx????xxxxxx????xxxxxx"
);

// v1.00: 0x1406F92E0
// v1.01: 0x1406F3E20
SIG_SCAN
(
	sigGameMode,
	"\x48\x89\x5C\x24\x00\x55\x56\x57\x41\x54\x41\x55\x48\x8D\x6C\x24\x00\x48\x81\xEC\x00\x00\x00\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x33\xC4\x48\x89\x45\x70\x48\x8B\xD9\x48\x89\x4C\x24\x00\x48\x8D\x0D\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x41\xBC\x00\x00\x00\x00\x48\x8D\x55\xD8\x45\x8B\xC4\x4C\x8B\xE8\x66\x0F\x1F\x44\x00\x00\x48\xC7\x42\x00\x00\x00\x00\x00\x48\xC7\x02\x00\x00\x00\x00\xC7\x42\x00\x00\x00\x00\x00\x48\x8D\x52\x14\x49\x83\xE8\x01\x75\xE0\x44\x38\x05\x00\x00\x00\x00\x74\x09\xE8\x00\x00\x00\x00\xC6\x40\x18\x01\x44\x8B\x8B\x00\x00\x00\x00\x41\x83\xF9\xFE\x75\x0D\x48\x8B\x83\x00\x00\x00\x00\x48\x8B\x08\x44\x8B\x09\xE8\x00\x00\x00\x00\x8B\x8B\x00\x00\x00\x00\x48\x8D\x55\xD4\x33\xFF\x48\x89\x44\x24\x00\x48\x8B\xF0\xC6\x45\x90\x00\x89\x08\x44\x8B\xC7\x8B\x8B\x00\x00\x00\x00\x89\x48\x04\x48\x8D\x4D\x49\xC6\x45\x98\x00\x89\x7D\x9C\x42\x89\x7C\x85\x00\x48\x8D\x49\x05\x42\x89\x7C\x85\x00\x49\xFF\xC0\x48\xC7\x42\x00\x00\x00\x00\x00\x48\xC7\x42\x00\x00\x00\x00\x00\xC7\x42\x00\x00\x00\x00\x00\x48\x8D\x52\x14\xC7\x41\x00\x00\x00\x00\x00\xC6\x41\xFE\x01\x4D\x3B\xC4\x7C\xC4",
	"xxxx?xxxxxxxxxxx?xxx????xxx????xxxxxxxxxxxxxx?xxx????x????xx????xxxxxxxxxxxxxxx?xxx?????xxx????xx?????xxxxxxxxxxxxx????xxx????xxxxxxx????xxxxxxxxx????xxxxxxx????xx????xxxxxxxxxx?xxxxxxxxxxxxxx????xxxxxxxxxxxxxxxxxx?xxxxxxxx?xxxxxx?????xxx?????xx?????xxxxxx?????xxxxxxxxx"
)

// v1.00: 0x14040FFA0
// v1.01: 0x14040B370
SIG_SCAN
(
	sigGetPVMode,
	"\x48\x89\x5C\x24\x00\x48\x89\x6C\x24\x00\x48\x89\x74\x24\x00\x57\x48\x83\xEC\x20\x33\xED\x48\xC7\x41\x00\x00\x00\x00\x00\x48\x8B\xF9\x48\x89\x29\x48\x89\x69\x08\x48\x8D\x99\x00\x00\x00\x00\x40\x88\x69\x10\x8D\x75\x04\x48\x89\x69\x14\x66\x89\x69\x1C\x89\x69\x28\xC7\x41\x00\x00\x00\x00\x00\x48\x8D\x8B\x00\x00\x00\x00\xC7\x83\x00\x00\x00\x00\x00\x00\x00\x00\x40\x88\xAB\x00\x00\x00\x00\x48\xC7\x83\x00\x00\x00\x00\x00\x00\x00\x00\x66\x89\xAB\x00\x00\x00\x00\x48\x89\xAB\x00\x00\x00\x00\x48\x89\xAB\x00\x00\x00\x00\x48\x89\xAB\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8D\x8B\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8D\x8B\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8D\x8B\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xB8\x00\x00\x00\x00\x4C\x8D\x8B\x00\x00\x00\x00\x0F\x1F\x40\x00\x41\xC7\x41\x00\x00\x00\x00\x00\x49\xC7\x41\x00\x00\x00\x00\x00\x41\x88\x29\x49\xC7\x41\x00\x00\x00\x00\x00\x41\x88\x69\x0C\x49\xC7\x41\x00\x00\x00\x00\x00\x41\x88\x69\x18\x49\xC7\x41\x00\x00\x00\x00\x00\x41\x88\x69\x24\x49\xC7\x41\x00\x00\x00\x00\x00\x41\x88\x69\x30\x49\x89\x69\xF0\x4D\x8D\x49\x48\x48\x83\xE8\x01\x75\xAF\x48\x8B\xCB\x89\x6B\xF8\xE8\x00\x00\x00\x00\x48\x8D\x4B\x18\xE8\x00\x00\x00\x00\x66\x89\x6B\x30\x40\x88\x6B\x32\xC7\x43\x00\x00\x00\x00\x00\x89\x6B\x38\xC7\x43\x00\x00\x00\x00\x00\x89\x6B\x40\x40\x88\x6B\x44\x89\x6B\x48\x48\x81\xC3\x00\x00\x00\x00\x48\x83\xEE\x01\x0F\x85\x00\x00\x00\x00\x48\x8D\x8F\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\x5C\x24\x00\x48\x8B\x6C\x24\x00\x48\x8B\x74\x24\x00\xC7\x87\x00\x00\x00\x00\x00\x00\x00\x00\x48\x83\xC4\x20\x5F\xC3",
	"xxxx?xxxx?xxxx?xxxxxxxxxx?????xxxxxxxxxxxxx????xxxxxxxxxxxxxxxxxxxx?????xxx????xx????????xxx????xxx????????xxx????xxx????xxx????xxx????x????xxx????x????xxx????x????xxx????x????x????xxx????xxxxxxx?????xxx?????xxxxxx?????xxxxxxx?????xxxxxxx?????xxxxxxx?????xxxxxxxxxxxxxxxxxxxxxxxxx????xxxxx????xxxxxxxxxx?????xxxxx?????xxxxxxxxxxxxx????xxxxxx????xxx????x????xxxx?xxxx?xxxx?xx????????xxxxxx"
)

HOOK(void, __fastcall, _SetGameMode, sigGameMode(), __int64 a1)
{
	original_SetGameMode(a1);

	if (*pvMode)
	{
		WRITE_MEMORY((char*)sigLyrics() + 0x38, uint8_t, 0x01);
	}
	else
	{
		WRITE_MEMORY((char*)sigLyrics() + 0x38, uint8_t, 0x00);
	}
}

extern "C" __declspec(dllexport) void Init()
{
	Config::init();

	if (Config::pvMark)
		WRITE_MEMORY(sigPVMark(), uint8_t, 0xC3);

	if (Config::copyrightMark) // Redirect to disablewm.farc
	{
		uint8_t* instrAddr = (uint8_t*)sigCopyright() + 0x10B;
		copyrightString = (char*)(instrAddr + readUnalignedU32(instrAddr + 0x3) + 0x7);
		printf("[Disable Watermarks] copyrightString: 0x%08x\n", copyrightString);
		WRITE_MEMORY(copyrightString, const char, "rom/disablewm.farc");
	}

	if (Config::hideLyrics)
	{
		uint8_t* instrAddr = (uint8_t*)sigGetPVMode() - 0x10;
		pvMode = (bool*)(instrAddr + readUnalignedU32(instrAddr + 0x3) + 0x20);
		printf("[Disable Watermarks] pvMode: 0x%08x\n", pvMode);
		INSTALL_HOOK(_SetGameMode);
	}
}
