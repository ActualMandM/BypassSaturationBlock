#include "Config.h"

// v1.0.0: 0x1414B2A74, 0x1414B2A78
bool* vsyncAddr;
uint32_t* capAddr;

// v1.0.0: 0x1402C0746
SIG_SCAN
(
	sigSingleThreadFlags,
	"\x41\x83\xC9\x08\xC7\x45\x00\x00\x00\x00\x00\x89\x75\xD0\x44\x89\x75\xD4\xC7\x45\x00\x00\x00\x00\x00\xC7\x45\x00\x00\x00\x00\x00\x48\xC7\x45\x00\x00\x00\x00\x00\x89\x4D\xE8\x48\xC7\x45\x00\x00\x00\x00\x00\xC7\x45\x00\x00\x00\x00\x00\xC7\x45\x00\x00\x00\x00\x00\x48\x89\x5D\x00\x83\xF7\x01\x89\x7D\x08\x89\x4D\x0C\xC7\x45\x00\x00\x00\x00\x00\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x44\x24\x00\x48\x8D\x45\x38\x48\x89\x44\x24\x00\x48\x8D\x05\x00\x00\x00\x00\x48\x89\x44\x24\x00\x4C\x89\x7C\x24\x00\x48\x8D\x45\xD0\x48\x89\x44\x24\x00\xC7\x44\x24\x00\x00\x00\x00\x00\xC7\x44\x24\x00\x00\x00\x00\x00\x48\x8D\x45\x20\x48\x89\x44\x24\x00\x45\x33\xC0\x8D\x51\x01\xFF\x15\x00\x00\x00\x00\x41\xC6\x87\x00\x00\x00\x00\x00\x85\xC0\x74\x0D\x41\xC6\x87\x00\x00\x00\x00\x00\xE9\x00\x00\x00\x00",
	"xxxxxx?????xxxxxxxxx?????xx?????xxx?????xxxxxx?????xx?????xx?????xxxxxxxxxxxxxxx?????xxx????xxxx?xxxxxxxx?xxx????xxxx?xxxx?xxxxxxxx?xxx?????xxx?????xxxxxxxx?xxxxxxxx????xxx?????xxxxxxx?????x????"
);

// v1.0.0: 0x1402B6CA0
SIG_SCAN
(
	sigSetFramerate,
	"\x48\x83\xEC\x28\x33\xC0\xC7\x05\x00\x00\x00\x00\x00\x00\x00\x00\x0F\x57\xC0\x48\x89\x05\x00\x00\x00\x00\xF3\x0F\x11\x05\x00\x00\x00\x00\x89\x05\x00\x00\x00\x00\x88\x05\x00\x00\x00\x00\x88\x05\x00\x00\x00\x00\x89\x05\x00\x00\x00\x00\x89\x05\x00\x00\x00\x00\x88\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\x48\x89\x05\x00\x00\x00\x00\xC7\x05\x00\x00\x00\x00\x00\x00\x00\x00\xC7\x05\x00\x00\x00\x00\x00\x00\x00\x00\x48\xC7\x05\x00\x00\x00\x00\x00\x00\x00\x00\xC7\x05\x00\x00\x00\x00\x00\x00\x00\x00\xC7\x05\x00\x00\x00\x00\x00\x00\x00\x00\xC6\x05\x00\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x84\xC0\x75\x2C\xE8\x00\x00\x00\x00\x84\xC0\x75\x07\xE8\x00\x00\x00\x00\xEB\x1C\xE8\x00\x00\x00\x00\x44\x8B\xC8\xE8\x00\x00\x00\x00\x8B\xD0\x41\x8B\xC9\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x48\x8B\xC8\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\x33\xD2\x33\xC9\xFF\x15\x00\x00\x00\x00\x48\x8D\x0D\x00\x00\x00\x00\x48\x83\xC4\x28\xE9\x00\x00\x00\x00",
	"xxxxxxxx????????xxxxxx????xxxx????xx????xx????xx????xx????xx????xx????xxx????xxx????xxx????xxx????xxx????xxx????xxx????xxx????xxx????xxx????xxx????xxx????xx????????xx????????xxx????????xx????????xx????????xx?????x????x????xxxxx????xxxxx????xxx????xxxx????xxxxxx????x????x????xxxx????x????x????x????x????x????x????x????x????x????xxxxxx????xxx????xxxxx????"
);

// v1.0.0: 0x1405FBA80
SIG_SCAN
(
	sigSetFramerateGame,
	"\x40\x53\x48\x81\xEC\x00\x00\x00\x00\x48\x8B\x05\x00\x00\x00\x00\x48\x33\xC4\x48\x89\x84\x24\x00\x00\x00\x00\x48\x8B\xD9\x48\x8D\x4C\x24\x00\xE8\x00\x00\x00\x00\xE8\x00\x00\x00\x00\xFF\xC8\x8B\x0B\x85\xC9\x79\x04\x33\xC9\xEB\x05\x3B\xC1\x0F\x4C\xC8\x89\x0B\x48\x8D\x4C\x24\x00\xE8\x00\x00\x00\x00\x90\x4C\x8D\x44\x24\x00\x8B\x13\xE8\x00\x00\x00\x00\x84\xC0\x74\x0E\x8B\x54\x24\x6C\x8B\x4C\x24\x68\xE8\x00\x00\x00\x00\x90\x48\x8D\x4C\x24\x00\xE8\x00\x00\x00\x00\x48\x8B\x8C\x24\x00\x00\x00\x00\x48\x33\xCC\xE8\x00\x00\x00\x00\x48\x81\xC4\x00\x00\x00\x00\x5B\xC3",
	"xxxxx????xxx????xxxxxxx????xxxxxxx?x????x????xxxxxxxxxxxxxxxxxxxxxxx?x????xxxxx?xxx????xxxxxxxxxxxxx????xxxxx?x????xxxx????xxxx????xxx????xx"
);

// v1.0.0: 0x1402B6EF0
HOOK(void, __fastcall, _SetFramerate, (char*)sigSetFramerate() + 0x250)
{
	*(bool*)vsyncAddr = Config::enableVSync;
	*(uint32_t*)capAddr = Config::framerateCap;
}

// v1.0.0: 0x1405FBB3E
HOOK(void, __fastcall, _SetFramerateGame, (char*)sigSetFramerateGame() + 0xBE)
{
	*(bool*)vsyncAddr = Config::enableVSync;
	*(uint32_t*)capAddr = Config::framerateCap;
}

extern "C" __declspec(dllexport) void Init()
{
	Config::init();

	uint8_t* instrAddr = (uint8_t*)sigSetFramerate() + 0x250;
	vsyncAddr = (bool*)(instrAddr + readUnalignedU32(instrAddr + 0x2) + 0x6);
	instrAddr += 0x6;
	capAddr = (uint32_t*)(instrAddr + readUnalignedU32(instrAddr + 0x2) + 0xA);

	printf("[High Refresh Rate] vsyncAddr: 0x%08x\n", vsyncAddr);
	printf("[High Refresh Rate] capAddr: 0x%08x\n", capAddr);

	// Apply patches and install hooks.
	if (Config::multiThreaded)
		WRITE_MEMORY(sigSingleThreadFlags(), uint8_t, 0x45, 0x31, 0xC9, 0x90);

	if (Config::affectMenus)
	{
		INSTALL_HOOK(_SetFramerate);
	}
	else
	{
		INSTALL_HOOK(_SetFramerateGame);
	}
}
